#include <stdio.h>

#include <reed_solomon.h>

#include <util.h>

#define TEST_WRAPPER(_rs, _inf_symbols, _rep_symbols)                          \
    do {                                                                       \
        if (test((_rs), (_inf_symbols), (_rep_symbols))) {                     \
            free_all((_rs));                                                   \
            return 1;                                                          \
        }                                                                      \
    } while (0)

static int test(const RS_t *rs, symbol_seq_t inf_symbols,
                symbol_seq_t rep_symbols) {
    symbol_seq_t _rep_symbols;
    int ret;

    ret = seq_alloc(rep_symbols.symbol_size, rep_symbols.length, &_rep_symbols);
    if (ret) {
        printf("ERROR: seq_alloc returned %d\n", ret);
        return ret;
    }

    rs_generate_repair_symbols(rs, inf_symbols, _rep_symbols);

    if (!util_seq_eq(_rep_symbols, rep_symbols)) {
        printf(
            "ERROR: rs_generate_repair_symbols(...): incorrect rep_symbols:\n");

        printf("\tcorrect = ");
        util_seq_printf(rep_symbols);
        printf("\n");

        printf("\tactual  = ");
        util_seq_printf(_rep_symbols);
        printf("\n");

        ret = 1;
    }

    seq_free(&_rep_symbols);

    return ret;
}

static void free_all(RS_t *rs) {
    GF_t *gf = rs->gf;
    CC_t *cc = rs->cc;
    FFT_t *fft = rs->fft;

    rs_free(rs);
    fft_free(fft);
    cc_free(cc);
    gf_free(gf);
}

int main(void) {
    GF_t _gf;
    CC_t _cc;
    FFT_t _fft;
    RS_t _rs;
    RS_t *rs = &_rs;

    {
        GF_t *gf = &_gf;
        CC_t *cc = &_cc;
        FFT_t *fft = &_fft;

        int ret = 0;

        ret = gf_alloc(gf);
        if (ret) {
            printf("ERROR: gf_alloc returned %d\n", ret);
            return ret;
        }

        gf_init(gf);

        ret = cc_alloc(cc);
        if (ret) {
            printf("ERROR: cc_alloc returned %d\n", ret);
            gf_free(gf);
            return ret;
        }

        cc_init(cc);

        ret = fft_alloc(fft);
        if (ret) {
            printf("ERROR: fft_alloc returned %d\n", ret);
            cc_free(cc);
            gf_free(gf);
            return ret;
        }

        fft_init(fft, gf);

        ret = rs_alloc(rs);
        if (ret) {
            printf("ERROR: rs_alloc returned %d\n", ret);
            fft_free(fft);
            cc_free(cc);
            gf_free(gf);
            return ret;
        }

        rs_init(rs, gf, cc, fft);
    }

    // Test data obtained by SageMath.
    // Code also was generated by Python and SageMath.

    // Test 1
    {
        element_t inf_symbols_data[22][1] = {
            {28222}, {49241}, {45586}, {1174},  {5315},  {65019},
            {47675}, {56163}, {40156}, {33812}, {32586}, {47263},
            {55278}, {8002},  {22366}, {42848}, {27917}, {8516},
            {932},   {16044}, {22012}, {15744}};
        element_t rep_symbols_data[17][1] = {
            {34028}, {43774}, {39723}, {64745}, {29660}, {9790},
            {12448}, {44479}, {23203}, {21930}, {56941}, {11328},
            {52660}, {46877}, {56327}, {2120},  {48350}};
        symbol_t inf_symbols_array[22] = {
            {.data = inf_symbols_data[0]},  {.data = inf_symbols_data[1]},
            {.data = inf_symbols_data[2]},  {.data = inf_symbols_data[3]},
            {.data = inf_symbols_data[4]},  {.data = inf_symbols_data[5]},
            {.data = inf_symbols_data[6]},  {.data = inf_symbols_data[7]},
            {.data = inf_symbols_data[8]},  {.data = inf_symbols_data[9]},
            {.data = inf_symbols_data[10]}, {.data = inf_symbols_data[11]},
            {.data = inf_symbols_data[12]}, {.data = inf_symbols_data[13]},
            {.data = inf_symbols_data[14]}, {.data = inf_symbols_data[15]},
            {.data = inf_symbols_data[16]}, {.data = inf_symbols_data[17]},
            {.data = inf_symbols_data[18]}, {.data = inf_symbols_data[19]},
            {.data = inf_symbols_data[20]}, {.data = inf_symbols_data[21]}};
        symbol_t rep_symbols_array[17] = {
            {.data = rep_symbols_data[0]},  {.data = rep_symbols_data[1]},
            {.data = rep_symbols_data[2]},  {.data = rep_symbols_data[3]},
            {.data = rep_symbols_data[4]},  {.data = rep_symbols_data[5]},
            {.data = rep_symbols_data[6]},  {.data = rep_symbols_data[7]},
            {.data = rep_symbols_data[8]},  {.data = rep_symbols_data[9]},
            {.data = rep_symbols_data[10]}, {.data = rep_symbols_data[11]},
            {.data = rep_symbols_data[12]}, {.data = rep_symbols_data[13]},
            {.data = rep_symbols_data[14]}, {.data = rep_symbols_data[15]},
            {.data = rep_symbols_data[16]}};
        symbol_seq_t inf_symbols = {
            .symbol_size = 1, .length = 22, .symbols = inf_symbols_array};
        symbol_seq_t rep_symbols = {
            .symbol_size = 1, .length = 17, .symbols = rep_symbols_array};

        TEST_WRAPPER(rs, inf_symbols, rep_symbols);
    }

    // Test 2
    {
        element_t inf_symbols_data[13][2] = {
            {56920, 16793}, {33130, 40268}, {30385, 30842}, {20774, 9799},
            {37410, 45592}, {29710, 26620}, {49637, 14238}, {39570, 9785},
            {62738, 16249}, {27937, 30494}, {31125, 39671}, {63610, 31023},
            {42149, 13675}};
        element_t rep_symbols_data[8][2] = {
            {30836, 41572}, {38080, 20501}, {28752, 34893}, {63353, 480},
            {44738, 47639}, {47377, 60654}, {63425, 14891}, {62216, 53105}};
        symbol_t inf_symbols_array[13] = {
            {.data = inf_symbols_data[0]},  {.data = inf_symbols_data[1]},
            {.data = inf_symbols_data[2]},  {.data = inf_symbols_data[3]},
            {.data = inf_symbols_data[4]},  {.data = inf_symbols_data[5]},
            {.data = inf_symbols_data[6]},  {.data = inf_symbols_data[7]},
            {.data = inf_symbols_data[8]},  {.data = inf_symbols_data[9]},
            {.data = inf_symbols_data[10]}, {.data = inf_symbols_data[11]},
            {.data = inf_symbols_data[12]}};
        symbol_t rep_symbols_array[8] = {
            {.data = rep_symbols_data[0]}, {.data = rep_symbols_data[1]},
            {.data = rep_symbols_data[2]}, {.data = rep_symbols_data[3]},
            {.data = rep_symbols_data[4]}, {.data = rep_symbols_data[5]},
            {.data = rep_symbols_data[6]}, {.data = rep_symbols_data[7]}};
        symbol_seq_t inf_symbols = {
            .symbol_size = 2, .length = 13, .symbols = inf_symbols_array};
        symbol_seq_t rep_symbols = {
            .symbol_size = 2, .length = 8, .symbols = rep_symbols_array};

        TEST_WRAPPER(rs, inf_symbols, rep_symbols);
    }

    // Test 3
    {
        element_t inf_symbols_data[7][3] = {
            {61130, 15802, 10371}, {4956, 37897, 35767},  {59887, 23328, 12937},
            {19330, 20567, 18313}, {61714, 21158, 46448}, {47751, 23274, 6316},
            {11718, 9473, 41793}};
        element_t rep_symbols_data[4][3] = {{43461, 34836, 37845},
                                            {22873, 50487, 26034},
                                            {53381, 46278, 1715},
                                            {6577, 30316, 10365}};
        symbol_t inf_symbols_array[7] = {
            {.data = inf_symbols_data[0]}, {.data = inf_symbols_data[1]},
            {.data = inf_symbols_data[2]}, {.data = inf_symbols_data[3]},
            {.data = inf_symbols_data[4]}, {.data = inf_symbols_data[5]},
            {.data = inf_symbols_data[6]}};
        symbol_t rep_symbols_array[4] = {{.data = rep_symbols_data[0]},
                                         {.data = rep_symbols_data[1]},
                                         {.data = rep_symbols_data[2]},
                                         {.data = rep_symbols_data[3]}};
        symbol_seq_t inf_symbols = {
            .symbol_size = 3, .length = 7, .symbols = inf_symbols_array};
        symbol_seq_t rep_symbols = {
            .symbol_size = 3, .length = 4, .symbols = rep_symbols_array};

        TEST_WRAPPER(rs, inf_symbols, rep_symbols);
    }

    free_all(rs);

    return 0;
}